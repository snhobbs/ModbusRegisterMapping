{# Jinja Template #}
/*
 * Copyright {{ timestamp.year }} ElectroOptical Innovations, LLC
 * {{ fname }}
 * Autogenerated file: {{ timestamp.date().isoformat() }}
 */

#pragma once

#include <DataStores/DataStores.h>
#include <Utilities/TypeConversion.h>
#include <ArrayView/ArrayView.h>
#include <algorithm>
#include <array>
#include <cstdint>

struct {{ name }} {
  {%- for entry in entries %}
    {%- if(entry.length > 1) %}
    {{ entry.dtype_ctype }} {{ entry.name }}[{{ entry.length }}]{};
    {%- else %}
    {{ entry.dtype_ctype }} {{ entry.name }}{};
    {%- endif %}
  {%- endfor %}
};

enum class {{ name }}EntryIdentifier {
  {%- for entry in entries %}
  {{ entry.name }} ,
  {%- endfor %}
  unknown
};

class {{ name }}Wrapper {
 public:
  static const constexpr std::size_t entries_ = {{ entries | length }};
  static const constexpr std::array<DataStores::StructEntry<{{ name }}EntryIdentifier>, entries_> entry_positions_ {
    {%- for entry in entries %}
    DataStores::StructEntry<{{ name }}EntryIdentifier>{ {{ name }}EntryIdentifier::{{ entry.name }}, offsetof({{ name }}, {{ entry.name }}), sizeof({{ name }}::{{ entry.name }}) },
    {%- endfor %}
  };

 private:
  {{ name }}* data_bank_{};

 public:
  explicit {{ name }}Wrapper({{name}}* data_bank) : data_bank_{data_bank} {}
  static const constexpr std::size_t size() {
    return sizeof({{ name }});
  }

  void SetField(const std::size_t index, const uint8_t* data, const std::size_t size) {
    const {{name}}EntryIdentifier identifier = static_cast<{{name}}EntryIdentifier>(index);
    switch (identifier) {
      case({{name}}EntryIdentifier::unknown): {
        // Ignore this case, should be scrubed
        break;
      }
      {%- for entry in entries %}
      case({{name}}EntryIdentifier::{{ entry.name }}) : {
      {% if entry.dtype.name in ['int8_t', 'uint8_t', 'kString'] %}
      {% if entry.length > 1 %}
        for (std::size_t i = 0; i < std::min(sizeof(data_bank_->{{ entry.name }}), size); i++) {
          data_bank_->{{ entry.name }}[i] = data[i];
        }
      {% else %}
          data_bank_->{{ entry.name }} = data[0];
      {% endif %}

      {% else %}
        const auto value = Utilities::Make_MSB_IntegerTypeFromArray<{{ entry.dtype_ctype }}, uint8_t>(data, size);
        data_bank_->{{ entry.name }} = value;
      {% endif %}
        break;
      }
      {%- endfor %}
      default:
        break;
    }
  }

  void GetField(const std::size_t index, uint8_t* data, const std::size_t size) const {
    const {{name}}EntryIdentifier identifier = static_cast<{{name}}EntryIdentifier>(index);
    switch (identifier) {
      case({{name}}EntryIdentifier::unknown): {
        // Ignore this case, should be scrubed
        break;
      }
      {%- for entry in entries %}
      case({{name}}EntryIdentifier::{{ entry.name }}) : {
      {% if entry.dtype.name in ['int8_t', 'uint8_t', 'kString'] %}
      {% if entry.length > 1 %}
        for (std::size_t i = 0; i < std::min(sizeof(data_bank_->{{ entry.name }}), size); i++) {
          data[i] = data_bank_->{{ entry.name }}[i];
        }
      {% else %}
          data[0] = data_bank_->{{ entry.name }};
      {% endif %}
      {% else %}
        const auto value = data_bank_->{{ entry.name }};
        const auto array = Utilities::MakeMSBU8Array<{{ entry.dtype_ctype }}>(value);
        for (std::size_t i = 0; i < std::min(array.size(), size); i++) {
          data[i] = array.at(i);
        }
      {% endif %}
        break;
      }
      {%- endfor %}
      default:
        break;
    }
  }

  {%- for entry in entries %}
  {%- if entry.length > 1 %}
  ArrayView<const {{ entry.dtype_ctype }}> get_{{ entry.name }}(void) const {
    return ArrayView<const {{ entry.dtype_ctype }}>{ {{ entry.length }}, data_bank_->{{ entry.name }} };
  }
  void set_{{ entry.name }}(const {{ entry.dtype_ctype }} *const value, std::size_t length) {
    for (std::size_t i = 0; i < length; i++) {
      data_bank_->{{ entry.name }}[i] = value[i];
    }
  }
  {%- else %}
  {{ entry.dtype_ctype }} get_{{ entry.name }}(void) const {
    return data_bank_->{{ entry.name }};
  }
  void set_{{ entry.name }}({{ entry.dtype_ctype }} value) {
    data_bank_->{{ entry.name }} = value;
  }
  {%- endif %}
  {%- endfor %}
  };  // class {{name}}Wrapper
